================================================================================
                    AUDIT CORTEZ2 - ANÁLISIS DE CONSISTENCIA
                    AI-Native MVP - Diciembre 2025
================================================================================

Autor: Análisis Arquitectónico Senior
Fecha: 2025-12-12
Scope: Backend ↔ Frontend ↔ DevOps Consistency

================================================================================
                           RESUMEN EJECUTIVO
================================================================================

Total de Defectos Identificados: 156
- CRÍTICOS: 24
- ALTOS: 42
- MEDIOS: 58
- BAJOS: 32

Categorías:
- Backend-Frontend Inconsistencias: 67
- DevOps Inconsistencias: 29
- Database-Schema Mismatches: 35
- API Contract Violations: 25

================================================================================
                    SECCIÓN 1: AUTENTICACIÓN INCONSISTENTE
================================================================================

1.1 ENDPOINTS SIN AUTENTICACIÓN (CRÍTICO)
-----------------------------------------
74% de los endpoints NO tienen autenticación a pesar de manejar datos sensibles.

BACKEND - Endpoints sin auth que DEBERÍAN tenerlo:

| Router           | Endpoint                          | Método | Datos Sensibles |
|------------------|-----------------------------------|--------|-----------------|
| interactions     | /{session_id}/history             | GET    | Historial chat  |
| traces           | /{session_id}                     | GET    | Trazas N4       |
| traces           | /student/{student_id}             | GET    | Datos estudiante|
| risks            | /session/{session_id}             | GET    | Riesgos         |
| risks            | /student/{student_id}             | GET    | Perfil riesgo   |
| risks            | /critical                         | GET    | Alertas críticas|
| risks            | /evaluation/session/{session_id}  | GET    | Evaluación      |
| cognitive-path   | /{session_id}                     | GET    | Path cognitivo  |
| cognitive-path   | /{session_id}/summary             | GET    | Resumen         |
| simulators       | /interact                         | POST   | Interacciones   |
| simulators       | /interview/*                      | ALL    | Entrevistas     |
| simulators       | /incident/*                       | ALL    | Simulación      |
| activities       | / (CRUD completo)                 | ALL    | Contenido curso |
| sessions         | /{session_id}                     | GET    | Datos sesión    |
| sessions         | /{session_id}/end                 | POST   | Cierre sesión   |
| sessions         | /create-tutor                     | POST   | Crear sesión    |
| sessions         | /{session_id}/interact            | POST   | Interacción     |
| sessions         | /{session_id}/analytics-n4        | GET    | Analytics N4    |

CORRECCIÓN REQUERIDA:
```python
# backend/api/routers/traces.py
from ..deps import get_current_user

@router.get("/{session_id}")
async def get_session_traces(
    session_id: str,
    current_user: dict = Depends(get_current_user),  # AGREGAR
    ...
):
```

Aplicar patrón similar a TODOS los endpoints listados arriba.

--------------------------------------------------------------------------------

1.2 PATRONES DE AUTH INCONSISTENTES (ALTO)
------------------------------------------
Múltiples implementaciones de autenticación:

| Patrón                  | Ubicación               | Retorna        |
|-------------------------|-------------------------|----------------|
| get_current_user        | deps.py                 | dict           |
| require_teacher_role    | teacher_tools.py        | dict + valida  |
| require_admin_role      | admin_llm.py (local)    | dict + valida  |

PROBLEMA: require_admin_role está definido LOCALMENTE en admin_llm.py, no en deps.py

CORRECCIÓN:
```python
# backend/api/deps.py - AGREGAR
async def require_admin_role(
    current_user: dict = Depends(get_current_user)
) -> dict:
    """Dependency that requires admin role"""
    if "admin" not in current_user.get("roles", []):
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Admin role required"
        )
    return current_user

async def require_student_role(
    current_user: dict = Depends(get_current_user)
) -> dict:
    """Dependency that requires student role"""
    if "student" not in current_user.get("roles", []):
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Student role required"
        )
    return current_user
```

================================================================================
                    SECCIÓN 2: INCONSISTENCIAS BACKEND-FRONTEND
================================================================================

2.1 RUTAS DEFINIDAS EN FRONTEND SIN PÁGINA (CRÍTICO)
----------------------------------------------------
Archivo: frontEnd/src/core/config/routes.config.ts

| Ruta Config     | Página Existe | Componente Feature | Estado    |
|-----------------|---------------|-------------------|-----------|
| /evaluator      | NO            | ProcessEvaluator  | ROTO      |
| /risks          | NO            | RiskAnalyzer      | ROTO      |
| /traceability   | NO            | TraceabilityViewer| ROTO      |
| /git            | NO            | GitAnalytics      | ROTO      |
| /teacher        | NO            | -                 | ROTO      |
| /admin          | NO            | -                 | ROTO      |
| /playground     | NO            | -                 | ROTO      |
| /sessions       | NO            | -                 | ROTO (*)  |

(*) DashboardPage.tsx:237 tiene link a /sessions que no existe

CORRECCIÓN - Crear páginas faltantes o eliminar rutas:
```typescript
// frontEnd/src/pages/EvaluatorPage.tsx (CREAR)
import ProcessEvaluator from '../features/evaluator/components/ProcessEvaluator';
export default function EvaluatorPage() {
  return <ProcessEvaluator />;
}

// frontEnd/src/App.tsx - AGREGAR rutas
<Route path="evaluator" element={<EvaluatorPage />} />
<Route path="risks" element={<RisksPage />} />
<Route path="git" element={<GitAnalyticsPage />} />
```

--------------------------------------------------------------------------------

2.2 SERVICIOS FRONTEND CON PATRONES DUALES (CRÍTICO)
----------------------------------------------------
El frontend usa DOS patrones de servicios incompatibles:

PATRÓN 1 (Pages): frontEnd/src/services/api/
```typescript
import { sessionsService } from '../services/api';
sessionsService.list(studentId, pagination);  // Funciona
```

PATRÓN 2 (Features): frontEnd/src/core/services/
```typescript
import { sessionService } from '@/core/services/SessionService';
sessionService.listAll();  // ❌ MÉTODO NO EXISTE
```

ARCHIVOS AFECTADOS:
- frontEnd/src/features/risks/components/RiskAnalyzer.tsx:99
- frontEnd/src/features/traceability/components/TraceabilityViewer.tsx
- frontEnd/src/features/tutor/components/TutorChat.tsx

CORRECCIÓN:
```typescript
// frontEnd/src/features/risks/components/RiskAnalyzer.tsx
// ANTES (INCORRECTO):
const data = await sessionService.listAll();

// DESPUÉS (CORRECTO):
import { sessionsService } from '../../../services/api';
const data = await sessionsService.list(studentId);
```

--------------------------------------------------------------------------------

2.3 IMPORTACIÓN DE ARCHIVO ELIMINADO (CRÍTICO)
----------------------------------------------
Archivo: frontEnd/src/pages/TutorPage.tsx:7

```typescript
import TraceabilityViewer from '../components/TraceabilityViewer';  // ❌ ELIMINADO
```

Git status muestra: `D frontEnd/src/components/TraceabilityViewer.tsx`

CORRECCIÓN:
```typescript
// Opción 1: Usar el componente de features
import { TraceabilityViewer } from '../features/traceability/components/TraceabilityViewer';

// Opción 2: Eliminar la importación si no se usa
```

--------------------------------------------------------------------------------

2.4 API INDEFINIDA EN ExerciseDetailPage (CRÍTICO)
-------------------------------------------------
Archivo: frontEnd/src/pages/ExerciseDetailPage.tsx:71

```typescript
const response = await api.submitExercise({  // ❌ 'api' NO ESTÁ DEFINIDA
  exercise_id: exercise.id,
  code: code
});
```

CORRECCIÓN:
```typescript
import { activitiesService } from '../services/api';

const response = await activitiesService.submit({
  exercise_id: exercise.id,
  code: code
});
```

--------------------------------------------------------------------------------

2.5 FIRMA DE MÉTODO INCORRECTA (ALTO)
-------------------------------------
Archivo: frontEnd/src/pages/DashboardPage.tsx:43

```typescript
// USO ACTUAL (INCORRECTO):
sessionsService.list({ student_id: user?.id })

// FIRMA DEL SERVICIO:
async list(studentId: string, pagination?: PaginationParams)

// USO CORRECTO:
sessionsService.list(user?.id || '', pagination)
```

--------------------------------------------------------------------------------

2.6 ENDPOINTS BACKEND NO CONSUMIDOS POR FRONTEND (MEDIO)
--------------------------------------------------------
Endpoints implementados en backend sin servicio frontend:

| Endpoint                           | Router      | Frontend Service |
|------------------------------------|-------------|------------------|
| /events                            | events.py   | NO EXISTE        |
| /exercises                         | exercises.py| NO EXISTE        |
| /metrics                           | metrics.py  | Solo config      |
| /cognitive_status                  | cognitive   | NO EXISTE        |
| /risk_analysis/{session_id}        | risk_anal   | Formato difiere  |
| /institutional-risks/*             | inst_risks  | institutionalRisks|

--------------------------------------------------------------------------------

2.7 DATOS MOCK HARDCODEADOS (MEDIO)
-----------------------------------
Páginas que usan datos mock en lugar de API:

| Archivo                    | Línea  | Descripción                    |
|----------------------------|--------|--------------------------------|
| AnalyticsPage.tsx          | 71-79  | weeklyActivity hardcodeado     |
| SimulatorsPage.tsx         | 68-112 | Fallback a simuladores mock    |

CORRECCIÓN AnalyticsPage.tsx:
```typescript
// ANTES (mock):
const weeklyActivity = [
  { day: 'Lun', sessions: 3, interactions: 24 },
  // ... hardcodeado
];

// DESPUÉS (API call):
const [weeklyActivity, setWeeklyActivity] = useState([]);
useEffect(() => {
  const fetchWeeklyStats = async () => {
    const response = await reportsService.getWeeklyAnalytics(userId);
    setWeeklyActivity(response.data);
  };
  fetchWeeklyStats();
}, [userId]);
```

--------------------------------------------------------------------------------

2.8 ErrorBoundary FALTANTE (MEDIO)
----------------------------------
Archivo: frontEnd/src/App.tsx

Páginas CON ErrorBoundary:
- TutorPage ✓
- ExercisesPageNew ✓

Páginas SIN ErrorBoundary:
- SimulatorsPage ❌
- AnalyticsPage ❌
- DashboardPage ❌

CORRECCIÓN:
```typescript
<Route path="simulators" element={
  <ErrorBoundary>
    <SimulatorsPage />
  </ErrorBoundary>
} />
```

================================================================================
                    SECCIÓN 3: DATABASE-SCHEMA INCONSISTENCIAS
================================================================================

3.1 ORM MODELS SIN PYDANTIC SCHEMAS (CRÍTICO)
---------------------------------------------
Modelos de base de datos sin schemas API correspondientes:

| ORM Model          | Domain Model   | API Schema    | Estado   |
|--------------------|----------------|---------------|----------|
| CognitiveTraceDB   | CognitiveTrace | NINGUNO       | CRÍTICO  |
| RiskDB             | Risk           | NINGUNO       | CRÍTICO  |
| EvaluationDB       | EvaluationReport| NINGUNO      | CRÍTICO  |
| GitTraceDB         | GitTrace       | NINGUNO       | CRÍTICO  |
| SimulatorEventDB   | -              | NINGUNO       | CRÍTICO  |

CORRECCIÓN - Crear schemas faltantes:
```python
# backend/api/schemas/trace.py (CREAR)
from pydantic import BaseModel
from typing import Dict, Any, Optional, List
from datetime import datetime

class CognitiveTraceCreate(BaseModel):
    session_id: str
    student_id: str
    activity_id: str
    trace_level: str
    interaction_type: str
    content: str
    context: Optional[Dict[str, Any]] = None
    trace_metadata: Optional[Dict[str, Any]] = None
    cognitive_state: Optional[str] = None
    cognitive_intent: Optional[str] = None
    ai_involvement: float = 0.0

class CognitiveTraceResponse(BaseModel):
    id: str
    session_id: str
    created_at: datetime
    trace_level: str
    interaction_type: str
    content: str
    trace_metadata: Dict[str, Any]
    cognitive_state: Optional[str]
    ai_involvement: float

    class Config:
        from_attributes = True

# backend/api/schemas/risk.py (CREAR)
class RiskCreate(BaseModel):
    session_id: str
    student_id: str
    activity_id: str
    risk_type: str
    risk_level: str
    dimension: str
    description: str
    evidence: List[str] = []

class RiskResponse(BaseModel):
    id: str
    session_id: str
    risk_type: str
    risk_level: str
    dimension: str
    description: str
    resolved: bool
    created_at: datetime

    class Config:
        from_attributes = True
```

--------------------------------------------------------------------------------

3.2 REPOSITORIO FALTANTE: SimulatorEventRepository (CRÍTICO)
------------------------------------------------------------
SimulatorEventDB se usa con queries directas en routers en lugar de repository.

Archivo afectado: backend/api/routers/events.py

```python
# ACTUAL (INCORRECTO - query directa):
db_event = SimulatorEventDB(...)
db.add(db_event)
db.commit()
```

CORRECCIÓN - Crear repositorio:
```python
# backend/database/repositories.py - AGREGAR

class SimulatorEventRepository:
    """Repository for simulator events"""

    def __init__(self, db_session: Session):
        self.db = db_session

    def create(
        self,
        session_id: str,
        student_id: str,
        simulator_type: str,
        event_type: str,
        event_data: dict,
        description: Optional[str] = None,
        severity: Optional[str] = None
    ) -> SimulatorEventDB:
        event = SimulatorEventDB(
            id=str(uuid4()),
            session_id=session_id,
            student_id=student_id,
            simulator_type=simulator_type,
            event_type=event_type,
            event_data=event_data,
            description=description,
            severity=severity
        )
        self.db.add(event)
        self.db.commit()
        self.db.refresh(event)
        return event

    def get_by_session(self, session_id: str) -> List[SimulatorEventDB]:
        return (
            self.db.query(SimulatorEventDB)
            .filter(SimulatorEventDB.session_id == session_id)
            .order_by(SimulatorEventDB.timestamp)
            .all()
        )

    def get_by_student(
        self,
        student_id: str,
        limit: int = 100
    ) -> List[SimulatorEventDB]:
        return (
            self.db.query(SimulatorEventDB)
            .filter(SimulatorEventDB.student_id == student_id)
            .order_by(SimulatorEventDB.timestamp.desc())
            .limit(limit)
            .all()
        )
```

--------------------------------------------------------------------------------

3.3 NOMBRE DE CAMPO INCONSISTENTE: trace_metadata vs metadata (ALTO)
--------------------------------------------------------------------
| Capa          | Campo            | Archivo                    |
|---------------|------------------|----------------------------|
| ORM           | trace_metadata   | models.py:184              |
| Domain        | metadata         | models/trace.py:76         |
| Repository    | Maps ambos       | repositories.py:516        |

PROBLEMA: Confusión al trabajar con trazas - ¿usar metadata o trace_metadata?

CORRECCIÓN (Opción recomendada - unificar a trace_metadata):
```python
# backend/models/trace.py
class CognitiveTrace(BaseModel):
    # CAMBIAR de 'metadata' a 'trace_metadata'
    trace_metadata: Dict[str, Any] = Field(default_factory=dict)
```

--------------------------------------------------------------------------------

3.4 FK RELATIONSHIPS INCOMPLETAS (ALTO)
---------------------------------------
Foreign Keys sin back_populates o cascade:

| FK Column                    | Tabla          | Back_populates | Cascade    |
|------------------------------|----------------|----------------|------------|
| TraceSequenceDB.session_id   | sessions       | FALTA          | CASCADE ✓  |
| StudentProfileDB.user_id     | users          | FALTA          | SET NULL ✓ |
| ActivityDB.teacher_id        | users          | FALTA          | SET NULL ✓ |
| GitTraceDB.session_id        | sessions       | ✓              | FALTA      |
| RiskAlertDB.remediation_plan_id| remediation  | FALTA          | FALTA      |

CORRECCIÓN - Agregar back_populates:
```python
# backend/database/models.py

# En SessionDB, agregar:
trace_sequences = relationship("TraceSequenceDB", back_populates="session")

# En TraceSequenceDB, cambiar:
session = relationship("SessionDB", back_populates="trace_sequences")

# En GitTraceDB, agregar cascade:
session_id = Column(
    String(36),
    ForeignKey("sessions.id", ondelete="CASCADE"),  # AGREGAR ondelete
    nullable=False
)
```

--------------------------------------------------------------------------------

3.5 SPLIT DE CAMPO recommendations (MEDIO)
------------------------------------------
EvaluationDB almacena recommendations como JSON único:
```python
# ORM (models.py)
recommendations = Column(JSON)  # {"student": [...], "teacher": [...]}
```

Domain model los separa:
```python
# Domain (evaluation.py)
recommendations_student: List[str]
recommendations_teacher: List[str]
```

Repository hace el mapping (repositories.py:816-819), pero API schema debería reflejar esto.

================================================================================
                    SECCIÓN 4: DEVOPS INCONSISTENCIAS
================================================================================

4.1 REDIS SIN AUTENTICACIÓN EN docker-compose.redis.yml (CRÍTICO)
-----------------------------------------------------------------
Archivo: docker-compose.redis.yml:25-31

```yaml
# ACTUAL (SIN PASSWORD):
command: >
  redis-server
  --appendonly yes
  --maxmemory 512mb

# CORRECTO (CON PASSWORD):
command: >
  redis-server
  --appendonly yes
  --maxmemory 512mb
  --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD is required}
```

También corregir health check (línea 34):
```yaml
# ACTUAL:
test: ["CMD", "redis-cli", "ping"]

# CORRECTO:
test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
```

--------------------------------------------------------------------------------

4.2 KUBERNETES ConfigMap INCOMPLETO (CRÍTICO)
---------------------------------------------
Archivo: devops/kubernetes/staging/02-configmap.yaml

Variables FALTANTES (presentes en docker-compose.yml):
- POSTGRES_USER
- POSTGRES_DB
- OLLAMA_TIMEOUT
- OLLAMA_TEMPERATURE

Variable INCORRECTA:
```yaml
# ACTUAL:
LLM_PROVIDER: "mock"  # ❌ Inaceptable para staging

# CORRECTO:
LLM_PROVIDER: "ollama"
```

CORRECCIÓN:
```yaml
# devops/kubernetes/staging/02-configmap.yaml
data:
  POSTGRES_USER: "ai_native"
  POSTGRES_DB: "ai_native"
  LLM_PROVIDER: "ollama"
  OLLAMA_BASE_URL: "http://ollama:11434"
  OLLAMA_MODEL: "phi3"
  OLLAMA_TIMEOUT: "120"
  OLLAMA_TEMPERATURE: "0.7"
```

--------------------------------------------------------------------------------

4.3 KUBERNETES REDIS SIN PERSISTENCIA (ALTO)
--------------------------------------------
Archivo: devops/kubernetes/staging/05-redis.yaml:81-83

```yaml
# ACTUAL (VOLATILE):
volumes:
- name: redis-data
  emptyDir: {}  # ❌ Se pierde al reiniciar pod

# CORRECTO (PERSISTENTE):
volumes:
- name: redis-data
  persistentVolumeClaim:
    claimName: redis-pvc
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-pvc
  namespace: ai-native-staging
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 1Gi
```

--------------------------------------------------------------------------------

4.4 OLLAMA START_PERIOD INSUFICIENTE (ALTO)
-------------------------------------------
Archivo: docker-compose.yml:238

```yaml
# ACTUAL:
start_period: 60s  # ❌ Phi-3 tarda 2-5 min en descargar (2GB)

# CORRECTO:
start_period: 300s  # 5 minutos para descarga inicial
```

--------------------------------------------------------------------------------

4.5 POSTGRES HEALTH CHECK HARDCODEADO (MEDIO)
---------------------------------------------
Archivo: docker-compose.yml:127

```yaml
# ACTUAL:
test: ["CMD-SHELL", "pg_isready -U ai_native"]  # ❌ Hardcoded

# CORRECTO:
test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ai_native}"]
```

--------------------------------------------------------------------------------

4.6 KUBERNETES FRONTEND USA URL EXTERNA (MEDIO)
-----------------------------------------------
Archivo: devops/kubernetes/staging/07-frontend.yaml:54-55

```yaml
# ACTUAL (EXTERNA - más latencia):
- name: VITE_API_BASE_URL
  value: "https://api-staging.ai-native.tu-institucion.edu.ar/api/v1"

# MEJOR (INTERNA):
- name: VITE_API_BASE_URL
  value: "http://ai-native-backend:8000/api/v1"
```

--------------------------------------------------------------------------------

4.7 PROMETHEUS SIN ALERTAS (MEDIO)
----------------------------------
Archivo: prometheus.yml

FALTANTE: Reglas de alerta para:
- API response time > 2s
- Database connection pool exhausted
- Redis memory > 80%
- Ollama timeout rate
- Error rate > 5%

CORRECCIÓN - Crear archivo:
```yaml
# prometheus-alerts.yml (CREAR)
groups:
- name: ai-native-alerts
  rules:
  - alert: HighAPILatency
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High API latency detected"

  - alert: HighErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Error rate above 5%"

  - alert: RedisMemoryHigh
    expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Redis memory usage above 80%"
```

--------------------------------------------------------------------------------

4.8 VARIABLES .env.example FALTANTES (BAJO)
-------------------------------------------
Variables en docker-compose.yml pero NO en .env.example:
- OLLAMA_TIMEOUT
- DB_POOL_TIMEOUT
- CACHE_SALT

================================================================================
                    SECCIÓN 5: API CONTRACT VIOLATIONS
================================================================================

5.1 RESPONSE WRAPPER INCONSISTENTE (ALTO)
-----------------------------------------
Mayoría de endpoints usan APIResponse<T>, pero algunos no:

| Endpoint           | Wrapper Actual  | Esperado       |
|--------------------|-----------------|----------------|
| /health/live       | JSONResponse    | APIResponse    |
| /health/ready      | JSONResponse    | APIResponse    |
| /health/deep       | JSONResponse    | APIResponse    |
| /sessions/interact | Dict            | APIResponse    |
| /sessions/create-tutor | Dict        | APIResponse    |

CORRECCIÓN:
```python
# backend/api/routers/health.py
@router.get("/live")
async def liveness() -> APIResponse[dict]:
    return APIResponse(
        success=True,
        data={"status": "alive"},
        message="Service is alive"
    )
```

--------------------------------------------------------------------------------

5.2 SCHEMAS SIN TIPAR EN ENDPOINTS (ALTO)
-----------------------------------------
Endpoints usando Dict genérico en lugar de schemas tipados:

| Endpoint                    | Request Type    | Response Type  |
|-----------------------------|-----------------|----------------|
| /sessions/create-tutor      | CreateTutorRequest | Dict        |
| /sessions/{id}/interact     | Dict[str, Any]  | Dict           |
| /teacher/students/compare   | -               | Dict           |
| /teacher/alerts             | -               | Dict           |

CORRECCIÓN:
```python
# backend/api/schemas/tutor.py (CREAR)
class TutorInteractRequest(BaseModel):
    message: str
    student_profile: Optional[Dict[str, Any]] = None

class TutorInteractResponse(BaseModel):
    response: str
    intervention_type: str
    metadata: Dict[str, Any]
    semaforo: str

# En router:
@router.post("/{session_id}/interact")
async def interact(
    session_id: str,
    request: TutorInteractRequest,
) -> APIResponse[TutorInteractResponse]:
```

--------------------------------------------------------------------------------

5.3 PATH PATTERNS INCONSISTENTES (MEDIO)
----------------------------------------
Evaluación lógica en router de risks:

| Ruta Actual                      | Router    | Debería Estar En |
|----------------------------------|-----------|------------------|
| /risks/evaluation/session/{id}   | risks.py  | evaluations.py   |
| /risks/evaluation/student/{id}   | risks.py  | evaluations.py   |
| /risks/analyze-session/{id}      | risks.py  | risk_analysis.py |

CORRECCIÓN: Mover endpoints a routers apropiados o crear aliases.

--------------------------------------------------------------------------------

5.4 ENUM VALUES CASE MISMATCH (MEDIO)
-------------------------------------
Frontend espera lowercase, backend puede retornar mixed:

| Enum            | Frontend Espera              | Backend Puede Retornar |
|-----------------|------------------------------|------------------------|
| SessionStatus   | 'active', 'completed'        | Lowercase ✓            |
| RiskLevel       | 'low', 'medium', 'high'      | Lowercase ✓            |
| CognitiveIntent | 'UNDERSTANDING', 'PLANNING'  | UPPERCASE ✓            |
| TraceLevel      | 'n1_superficial', etc.       | Lowercase ✓            |

VERIFICAR: Todos los enums se serializan correctamente en lowercase donde corresponde.

================================================================================
                    SECCIÓN 6: SIMULATORS ROUTER OVERSIZED
================================================================================

6.1 ARCHIVO DEMASIADO GRANDE (MEDIO)
------------------------------------
Archivo: backend/api/routers/simulators.py - 1441 líneas

Combina 6 simuladores diferentes en un solo archivo.

CORRECCIÓN - Dividir en módulos:
```
backend/api/routers/simulators/
├── __init__.py           # Re-exports
├── base.py               # GET /simulators, GET /{type}
├── interview.py          # POST /interview/*
├── incident.py           # POST /incident/*
├── scrum.py              # POST /scrum/*
├── client.py             # POST /client/*
├── security.py           # POST /security/*
└── schemas.py            # Schemas compartidos
```

================================================================================
                    SECCIÓN 7: FRONTEND CLEANUP
================================================================================

7.1 IMPORTS NO USADOS (BAJO)
----------------------------
Archivo: frontEnd/src/pages/ExerciseDetailPage.tsx:5-17

```typescript
import {
  AlertCircle,  // ❌ No usado
  Star,         // ❌ Usado solo una vez
  // ...
} from 'lucide-react';
```

--------------------------------------------------------------------------------

7.2 CONSOLE.LOG SIN DEV CHECK (BAJO)
------------------------------------
Archivos con console.error sin verificación de entorno:

| Archivo                  | Línea | Código                              |
|--------------------------|-------|-------------------------------------|
| ExerciseDetailPage.tsx   | 39    | console.error('Error fetching...')  |
| SimulatorsPage.tsx       | varios| console.error en catch blocks       |

CORRECCIÓN:
```typescript
if (import.meta.env.DEV) {
  console.error('Error fetching exercise:', error);
}
```

--------------------------------------------------------------------------------

7.3 useEffect SIN CLEANUP (BAJO)
--------------------------------
Archivo: frontEnd/src/pages/ExerciseDetailPage.tsx

```typescript
// ACTUAL (sin cleanup):
useEffect(() => {
  const fetchExercise = async () => { /* ... */ };
  fetchExercise();
}, [id]);

// CORRECTO (con AbortController):
useEffect(() => {
  const abortController = new AbortController();
  const fetchExercise = async () => {
    try {
      const response = await activitiesService.getById(id, {
        signal: abortController.signal
      });
      // ...
    } catch (error) {
      if (!abortController.signal.aborted) {
        console.error(error);
      }
    }
  };
  fetchExercise();
  return () => abortController.abort();
}, [id]);
```

================================================================================
                    SECCIÓN 8: RESUMEN POR PRIORIDAD
================================================================================

CRÍTICOS (24) - Resolver inmediatamente:
------------------------------------------
1. 50+ endpoints sin autenticación
2. Rutas frontend sin páginas (7)
3. Servicios frontend con métodos inexistentes
4. Importación de archivo eliminado (TraceabilityViewer)
5. Variable 'api' indefinida en ExerciseDetailPage
6. 5 ORM models sin API schemas
7. SimulatorEventRepository faltante
8. Redis sin auth en docker-compose.redis.yml
9. Kubernetes ConfigMap con LLM_PROVIDER=mock

ALTOS (42) - Resolver esta semana:
----------------------------------
1. Patrones de auth inconsistentes
2. Firma de método incorrecta en DashboardPage
3. FK relationships incompletas (5)
4. Nombre de campo trace_metadata vs metadata
5. Kubernetes Redis sin persistencia
6. Ollama start_period insuficiente
7. Response wrapper inconsistente
8. Schemas sin tipar en endpoints

MEDIOS (58) - Resolver próximo sprint:
--------------------------------------
1. Endpoints backend no consumidos (6)
2. Datos mock hardcodeados (2 páginas)
3. ErrorBoundary faltante (3 páginas)
4. Path patterns inconsistentes
5. Postgres health check hardcodeado
6. Prometheus sin alertas
7. Simulators router oversized

BAJOS (32) - Technical debt:
----------------------------
1. Variables .env.example faltantes
2. Imports no usados
3. Console.log sin dev check
4. useEffect sin cleanup

================================================================================
                    SECCIÓN 9: SCRIPT DE MIGRACIÓN
================================================================================

Crear archivo: backend/database/migrations/add_cortez2_fixes.py

```python
"""
Migración: Correcciones del Audit Cortez2
- Schemas API faltantes
- SimulatorEventRepository
- FK relationships
"""
import sys
from sqlalchemy import text
from backend.database import init_database, get_db_config


def migrate_cortez2_fixes():
    """Aplica correcciones del audit Cortez2"""
    print("=" * 80)
    print("Migración: Correcciones Audit Cortez2")
    print("=" * 80)

    init_database()
    db_config = get_db_config()
    session_factory = db_config.get_session_factory()
    db = session_factory()

    try:
        db_url = str(db.bind.url)
        is_postgres = 'postgresql' in db_url

        # 1. Add missing indexes for SimulatorEventDB
        print("\n[1/3] Adding SimulatorEventDB indexes...")
        try:
            db.execute(text("""
                CREATE INDEX IF NOT EXISTS idx_sim_event_session
                ON simulator_events (session_id, timestamp)
            """))
            db.execute(text("""
                CREATE INDEX IF NOT EXISTS idx_sim_event_student
                ON simulator_events (student_id, simulator_type)
            """))
            print("✓ SimulatorEvent indexes created")
        except Exception as e:
            print(f"  ⚠ Error: {e}")

        # 2. Add cascade to GitTraceDB FK
        print("\n[2/3] Updating GitTraceDB FK cascade...")
        if is_postgres:
            try:
                # Drop and recreate FK with cascade
                db.execute(text("""
                    ALTER TABLE git_traces
                    DROP CONSTRAINT IF EXISTS git_traces_session_id_fkey
                """))
                db.execute(text("""
                    ALTER TABLE git_traces
                    ADD CONSTRAINT git_traces_session_id_fkey
                    FOREIGN KEY (session_id)
                    REFERENCES sessions(id)
                    ON DELETE CASCADE
                """))
                print("✓ GitTrace FK cascade updated")
            except Exception as e:
                print(f"  ⚠ Error: {e}")
        else:
            print("  ⏭ Skipping (SQLite)")

        # 3. Add index for RiskAlertDB
        print("\n[3/3] Adding RiskAlertDB indexes...")
        try:
            db.execute(text("""
                CREATE INDEX IF NOT EXISTS idx_risk_alert_plan
                ON risk_alerts (remediation_plan_id, status)
            """))
            print("✓ RiskAlert indexes created")
        except Exception as e:
            print(f"  ⚠ Error: {e}")

        db.commit()
        print("\n" + "=" * 80)
        print("✓ Migración Cortez2 completada")
        print("=" * 80)

    except Exception as e:
        print(f"\n✗ Error: {e}")
        db.rollback()
        raise
    finally:
        db.close()


if __name__ == "__main__":
    migrate_cortez2_fixes()
```

================================================================================
                    SECCIÓN 10: MÉTRICAS Y ESTIMACIÓN
================================================================================

ESTIMACIÓN DE ESFUERZO:
-----------------------
| Prioridad | Items | Horas Est. | Desarrolladores |
|-----------|-------|------------|-----------------|
| CRÍTICOS  | 24    | 40-60h     | 2 senior        |
| ALTOS     | 42    | 60-80h     | 2 senior        |
| MEDIOS    | 58    | 40-60h     | 1 senior + 1 mid|
| BAJOS     | 32    | 20-30h     | 1 mid           |
|-----------|-------|------------|-----------------|
| TOTAL     | 156   | 160-230h   | ~4-6 semanas    |

ARCHIVOS MÁS AFECTADOS:
-----------------------
1. backend/api/routers/simulators.py (1441 líneas, dividir)
2. backend/database/repositories.py (agregar SimulatorEventRepository)
3. backend/api/schemas/ (crear 5 nuevos archivos)
4. frontEnd/src/App.tsx (agregar 7 rutas)
5. frontEnd/src/pages/ (crear 7 páginas)
6. devops/kubernetes/staging/ (actualizar 4 archivos)
7. docker-compose.redis.yml (agregar auth)

================================================================================
                    FIN DEL AUDIT CORTEZ2
================================================================================
