# CORTEZ11 - Auditoría de Consistencia Base de Datos vs Backend

**Fecha**: Diciembre 2025
**Auditor**: Claude Code (Arquitecto de Software)
**Alcance**: Análisis de consistencia entre tablas de base de datos (ORM models.py) y backend (repositories.py, schemas/*.py)
**Metodología**: Revisión cruzada de nombres de tablas, campos ORM, métodos de repositorio y schemas Pydantic

---

## RESUMEN EJECUTIVO

| Categoría | Defectos Encontrados | Severidad |
|-----------|---------------------|-----------|
| Repositorios faltantes | 2 | MEDIA |
| Métodos de repositorio faltantes | 8 | MEDIA |
| Inconsistencias de nombres ORM vs Schema | 5 | BAJA |
| Campos ORM sin exposición en API | 4 | BAJA |
| Relaciones sin métodos de navegación | 3 | BAJA |
| Validaciones faltantes en repositorios | 4 | MEDIA |
| **TOTAL** | **26** | - |

---

## CATEGORÍA 1: REPOSITORIOS FALTANTES

### Defecto 1.1: StudentProfileRepository no existe
**Tabla**: `student_profiles` (StudentProfileDB)
**Severidad**: MEDIA
**Descripción**: El modelo ORM `StudentProfileDB` existe con 15+ campos pero NO existe un `StudentProfileRepository` en `repositories.py`.

**Campos ORM sin acceso via repositorio**:
- `student_id`, `user_id`, `name`, `email`
- `total_sessions`, `total_interactions`, `average_ai_dependency`
- `average_competency_level`, `average_competency_score`
- `total_risks`, `critical_risks`, `risk_trends`
- `competency_evolution`, `last_activity_date`
- `preferred_language`, `cognitive_preferences`, `learning_patterns`
- `competency_levels`, `strengths`, `areas_for_improvement`

**Impacto**: No hay forma estandarizada de crear, leer, actualizar o eliminar perfiles de estudiantes.

**Recomendación**:
```python
class StudentProfileRepository:
    def __init__(self, db_session: Session):
        self.db = db_session

    def create(self, student_id: str, user_id: Optional[str] = None, ...) -> StudentProfileDB: ...
    def get_by_student_id(self, student_id: str) -> Optional[StudentProfileDB]: ...
    def get_by_user_id(self, user_id: str) -> Optional[StudentProfileDB]: ...
    def update_metrics(self, student_id: str, ...) -> Optional[StudentProfileDB]: ...
    def update_competency_levels(self, student_id: str, levels: dict) -> Optional[StudentProfileDB]: ...
```

---

### Defecto 1.2: SimulatorEventRepository no existe
**Tabla**: `simulator_events` (SimulatorEventDB)
**Severidad**: MEDIA
**Descripción**: El modelo ORM `SimulatorEventDB` existe pero NO hay repositorio dedicado.

**Campos ORM**:
- `session_id`, `student_id`, `simulator_type`
- `event_type`, `event_data`, `timestamp`
- `description`, `severity`

**Impacto**: Los eventos de simuladores no tienen una capa de abstracción para operaciones CRUD.

**Recomendación**: Crear `SimulatorEventRepository` con métodos:
- `create(session_id, student_id, simulator_type, event_type, event_data, ...)`
- `get_by_session(session_id, limit, offset)`
- `get_by_student(student_id, simulator_type, limit)`
- `get_by_event_type(event_type, limit)`

---

## CATEGORÍA 2: MÉTODOS DE REPOSITORIO FALTANTES

### Defecto 2.1: SessionRepository - Falta método update_simulator_type
**Tabla**: `sessions`
**Campo ORM**: `simulator_type`
**Severidad**: MEDIA
**Descripción**: Existe `update_mode()` y `update_status()` pero NO `update_simulator_type()`.

**Código faltante**:
```python
def update_simulator_type(self, session_id: str, simulator_type: str) -> Optional[SessionDB]:
    """Update session simulator_type with pessimistic locking"""
    try:
        stmt = select(SessionDB).where(SessionDB.id == session_id).with_for_update()
        session = self.db.execute(stmt).scalar_one_or_none()
        if session:
            session.simulator_type = simulator_type
            self.db.commit()
            self.db.refresh(session)
            return session
        return None
    except Exception:
        self.db.rollback()
        raise
```

---

### Defecto 2.2: SessionRepository - Falta método update_cognitive_status
**Tabla**: `sessions`
**Campo ORM**: `cognitive_status` (JSONB)
**Severidad**: MEDIA
**Descripción**: El campo N4 `cognitive_status` es actualizado dinámicamente pero no hay método de repositorio.

**Código faltante**:
```python
def update_cognitive_status(self, session_id: str, cognitive_status: dict) -> Optional[SessionDB]:
    """Update session cognitive status for N4 traceability"""
    ...
```

---

### Defecto 2.3: SessionRepository - Falta método update_session_metrics
**Tabla**: `sessions`
**Campo ORM**: `session_metrics` (JSONB)
**Severidad**: MEDIA
**Descripción**: Las métricas agregadas de sesión no tienen método de actualización.

---

### Defecto 2.4: SessionRepository - Falta método update_learning_objective
**Tabla**: `sessions`
**Campo ORM**: `learning_objective` (JSONB)
**Severidad**: BAJA
**Descripción**: El objetivo de aprendizaje de la sesión no tiene método de actualización.

---

### Defecto 2.5: TraceRepository - Falta método get_by_activity
**Tabla**: `cognitive_traces`
**Campo ORM**: `activity_id`
**Severidad**: MEDIA
**Descripción**: Existe `get_by_session()` y `get_by_student()` pero NO `get_by_activity()`.

**Código faltante**:
```python
def get_by_activity(
    self,
    activity_id: str,
    limit: int = 100,
    offset: int = 0
) -> List[CognitiveTraceDB]:
    """Get all traces for an activity"""
    return (
        self.db.query(CognitiveTraceDB)
        .filter(CognitiveTraceDB.activity_id == activity_id)
        .order_by(CognitiveTraceDB.created_at)
        .limit(limit)
        .offset(offset)
        .all()
    )
```

---

### Defecto 2.6: RiskRepository - Falta método get_by_activity
**Tabla**: `risks`
**Campo ORM**: `activity_id`
**Severidad**: MEDIA
**Descripción**: Existe `get_by_session()` y `get_by_student()` pero NO `get_by_activity()`.

---

### Defecto 2.7: RiskRepository - Falta método get_by_dimension
**Tabla**: `risks`
**Campo ORM**: `dimension`
**Severidad**: MEDIA
**Descripción**: Hay índice `idx_student_activity_dimension` pero no hay método para filtrar por dimensión.

**Código faltante**:
```python
def get_by_dimension(
    self,
    dimension: str,
    session_id: Optional[str] = None,
    limit: int = 100
) -> List[RiskDB]:
    """Get risks by dimension (cognitive, ethical, epistemic, technical, governance)"""
    query = self.db.query(RiskDB).filter(RiskDB.dimension == dimension.lower())
    if session_id:
        query = query.filter(RiskDB.session_id == session_id)
    return query.order_by(desc(RiskDB.created_at)).limit(limit).all()
```

---

### Defecto 2.8: EvaluationRepository - Falta método get_by_activity
**Tabla**: `evaluations`
**Campo ORM**: `activity_id`
**Severidad**: MEDIA
**Descripción**: Índice existe (`idx_eval_student_activity`) pero no hay método `get_by_activity()`.

---

## CATEGORÍA 3: INCONSISTENCIAS DE NOMBRES ORM VS SCHEMA

### Defecto 3.1: CognitiveTraceDB.trace_metadata vs Schema metadata
**Tabla**: `cognitive_traces`
**ORM**: `trace_metadata = Column(JSON, default=dict)`
**Schema (CognitiveTraceCreate)**: `trace_metadata`
**Schema (CognitiveTraceResponse)**: `trace_metadata`
**Severidad**: BAJA
**Estado**: CORRECTO - Ya corregido en Cortez8

---

### Defecto 3.2: StudentProfileDB.risk_trends vs Schema.risk_profile
**Tabla**: `student_profiles`
**ORM**: `risk_trends = Column(JSON, default=dict)`
**Schema**: `risk_trends: Dict[str, Any] = Field(default_factory=dict, alias="risk_profile")`
**Severidad**: BAJA
**Descripción**: El ORM usa `risk_trends` pero el schema expone `risk_profile` como alias.

**Impacto**: Posible confusión al serializar/deserializar. El alias funciona pero el nombre real es diferente.

---

### Defecto 3.3: StudentProfileDB.last_activity_date vs Schema.last_session_at
**Tabla**: `student_profiles`
**ORM**: `last_activity_date = Column(DateTime, nullable=True)`
**Schema**: `last_activity_date: Optional[datetime] = Field(None, alias="last_session_at")`
**Severidad**: BAJA
**Descripción**: Alias `last_session_at` no coincide con nombre ORM `last_activity_date`.

---

### Defecto 3.4: EvaluationDB.recommendations vs Schema split
**Tabla**: `evaluations`
**ORM**: `recommendations = Column(JSON, default=list)` - JSON combinado
**Schema Create**: `recommendations_student: List[str]`, `recommendations_teacher: List[str]` - separados
**Schema Response**: `recommendations: List[str]` - combinado de nuevo
**Severidad**: BAJA
**Descripción**: La conversión student/teacher -> combined ocurre en repositorio pero puede perderse información.

**Ubicación**: `repositories.py:1234-1238`
```python
recommendations = {
    "student": evaluation.recommendations_student,
    "teacher": evaluation.recommendations_teacher,
}
```

---

### Defecto 3.5: GitTraceDB tiene dos timestamps diferentes
**Tabla**: `git_traces`
**ORM**:
  - `timestamp = Column(DateTime, nullable=False)` - Timestamp del commit Git
  - `created_at` (heredado de BaseModel) - Timestamp de creación del registro
**Severidad**: BAJA
**Descripción**: Documentado en FIX 10.11 Cortez10 pero puede generar confusión.

---

## CATEGORÍA 4: CAMPOS ORM SIN EXPOSICIÓN EN API

### Defecto 4.1: SessionDB.learning_objective sin endpoint
**Tabla**: `sessions`
**Campo ORM**: `learning_objective = Column(JSONBCompatible, default=dict, nullable=True)`
**Severidad**: BAJA
**Descripción**: Campo N4 existe en ORM y en `SessionDetailResponse` pero no hay endpoint para actualizarlo.

---

### Defecto 4.2: CognitiveTraceDB dimensiones N4 parcialmente expuestas
**Tabla**: `cognitive_traces`
**Campos ORM**:
- `semantic_understanding` (JSONB)
- `algorithmic_evolution` (JSONB)
- `cognitive_reasoning` (JSONB)
- `interactional_data` (JSONB)
- `ethical_risk_data` (JSONB)
- `process_data` (JSONB)
**Severidad**: BAJA
**Descripción**: Los schemas incluyen estos campos pero no hay endpoints específicos para consultar trazas por dimensión N4.

---

### Defecto 4.3: TraceSequenceDB.cognitive_coherence sin exposición
**Tabla**: `trace_sequences`
**Campo ORM**: NO existe `cognitive_coherence` en ORM
**Schema**: `cognitive_coherence: Optional[float] = Field(None, ge=0, le=1)`
**Severidad**: MEDIA
**Descripción**: El schema `TraceSequenceResponse` define `cognitive_coherence` pero el ORM `TraceSequenceDB` NO tiene este campo.

**Archivo**: `backend/api/schemas/trace.py:198`
**Archivo**: `backend/database/models.py:529-535` (TraceSequenceDB no tiene cognitive_coherence)

**Recomendación**: Agregar campo al ORM o remover del schema.
```python
# En models.py TraceSequenceDB:
cognitive_coherence = Column(Float, nullable=True)  # Coherencia cognitiva (0-1)
```

---

### Defecto 4.4: RemediationPlanDB sin schema Response completo
**Tabla**: `remediation_plans`
**ORM campos**: 18 campos
**Severidad**: BAJA
**Descripción**: No hay schema `RemediationPlanResponse` en schemas/. El repositorio existe pero falta schema Pydantic.

---

## CATEGORÍA 5: RELACIONES SIN MÉTODOS DE NAVEGACIÓN

### Defecto 5.1: SessionDB.simulator_events sin método get_by_session
**Tabla**: `sessions` -> `simulator_events`
**Relación ORM**: `simulator_events = relationship("SimulatorEventDB", ...)`
**Severidad**: BAJA
**Descripción**: La relación existe pero no hay `SimulatorEventRepository.get_by_session()`.

---

### Defecto 5.2: UserDB.student_profiles sin método de navegación
**Tabla**: `users` -> `student_profiles`
**Relación ORM**: `student_profiles = relationship("StudentProfileDB", ...)`
**Severidad**: BAJA
**Descripción**: No hay `StudentProfileRepository` ni método en `UserRepository` para obtener perfiles.

---

### Defecto 5.3: SessionDB.trace_sequences relación sin get_by_session_filtered
**Tabla**: `sessions` -> `trace_sequences`
**Relación ORM**: `trace_sequences = relationship("TraceSequenceDB", ...)`
**Severidad**: BAJA
**Descripción**: `TraceSequenceRepository.get_by_session()` existe pero no hay versión con filtros.

---

## CATEGORÍA 6: VALIDACIONES FALTANTES EN REPOSITORIOS

### Defecto 6.1: ActivityRepository.update no valida status actual
**Tabla**: `activities`
**Severidad**: MEDIA
**Descripción**: `update()` valida campos pero no verifica si la actividad está en estado válido para edición.

**Recomendación**: Agregar validación:
```python
if activity.status == "archived":
    raise ValueError("Cannot update archived activity")
```

---

### Defecto 6.2: RiskRepository.create no valida dimensión vs risk_type
**Tabla**: `risks`
**Severidad**: MEDIA
**Descripción**: No hay validación de que `risk_type` corresponda a la `dimension` correcta.

**Ejemplo de inconsistencia permitida**:
- `dimension="cognitive"` con `risk_type="security_vulnerability"` (debería ser `technical`)

---

### Defecto 6.3: EvaluationRepository.create no valida overall_score range
**Tabla**: `evaluations`
**Severidad**: BAJA
**Descripción**: El schema valida `ge=0, le=10` pero el repositorio no. Si se usa directamente sin pasar por schema, puede insertar valores inválidos.

**Recomendación**: Agregar validación en repositorio:
```python
if not (0 <= evaluation.overall_score <= 10):
    raise ValueError("overall_score must be between 0 and 10")
```

---

### Defecto 6.4: GitTraceRepository.create no valida commit_hash format
**Tabla**: `git_traces`
**Severidad**: BAJA
**Descripción**: El campo `commit_hash` debería ser SHA-1 (40 caracteres hex) pero no se valida.

**Recomendación**:
```python
import re
if not re.match(r'^[a-f0-9]{40}$', commit_hash):
    raise ValueError("commit_hash must be valid SHA-1 (40 hex characters)")
```

---

## RESUMEN DE TABLAS ANALIZADAS

| Tabla | Repositorio Existe | Métodos Completos | Schema Completo |
|-------|-------------------|-------------------|-----------------|
| sessions | ✅ | ⚠️ (falta 4) | ✅ |
| cognitive_traces | ✅ | ⚠️ (falta 1) | ✅ |
| risks | ✅ | ⚠️ (falta 2) | ✅ |
| evaluations | ✅ | ⚠️ (falta 1) | ✅ |
| trace_sequences | ✅ | ✅ | ⚠️ (cognitive_coherence) |
| student_profiles | ❌ | N/A | ✅ |
| activities | ✅ | ✅ | ✅ |
| users | ✅ | ✅ | ✅ |
| git_traces | ✅ | ⚠️ (validación) | ✅ |
| course_reports | ✅ | ✅ | ⚠️ (sin schema) |
| remediation_plans | ✅ | ✅ | ⚠️ (sin schema) |
| risk_alerts | ✅ | ✅ | ⚠️ (sin schema) |
| interview_sessions | ✅ | ✅ | ⚠️ (parcial) |
| incident_simulations | ✅ | ✅ | ⚠️ (parcial) |
| lti_deployments | ✅ | ✅ | ⚠️ (parcial) |
| simulator_events | ❌ | N/A | ❌ |
| lti_sessions | ✅ | ✅ | ⚠️ (parcial) |

**Leyenda**: ✅ Completo | ⚠️ Parcial | ❌ Faltante

---

## PRIORIZACIÓN DE CORRECCIONES

### Alta Prioridad (Funcionalidad afectada)
1. **1.1** - Crear StudentProfileRepository
2. **1.2** - Crear SimulatorEventRepository
3. **4.3** - Agregar `cognitive_coherence` a TraceSequenceDB o remover de schema

### Media Prioridad (Mejoras de consistencia)
4. **2.5** - TraceRepository.get_by_activity()
5. **2.6** - RiskRepository.get_by_activity()
6. **2.7** - RiskRepository.get_by_dimension()
7. **6.2** - Validar dimension vs risk_type

### Baja Prioridad (Mejoras menores)
8. Resto de defectos de nomenclatura y validaciones

---

## MIGRACIÓN PROPUESTA

```python
# backend/database/migrations/add_cortez11_fixes.py

def upgrade():
    """Cortez11 audit fixes"""

    # FIX 4.3: Add cognitive_coherence to trace_sequences
    op.add_column(
        'trace_sequences',
        sa.Column('cognitive_coherence', sa.Float, nullable=True)
    )

    # Add check constraint for cognitive_coherence range
    op.create_check_constraint(
        'ck_seq_cognitive_coherence_range',
        'trace_sequences',
        'cognitive_coherence IS NULL OR (cognitive_coherence >= 0 AND cognitive_coherence <= 1)'
    )

def rollback():
    op.drop_constraint('ck_seq_cognitive_coherence_range', 'trace_sequences')
    op.drop_column('trace_sequences', 'cognitive_coherence')
```

---

## ARCHIVOS AFECTADOS

| Archivo | Cambios Requeridos |
|---------|-------------------|
| `backend/database/repositories.py` | Agregar StudentProfileRepository, SimulatorEventRepository, métodos faltantes |
| `backend/database/models.py` | Agregar cognitive_coherence a TraceSequenceDB |
| `backend/api/schemas/trace.py` | Actualizar TraceSequenceResponse si se mantiene cognitive_coherence |
| `backend/api/schemas/sprint5_6.py` | Agregar schemas faltantes para RemediationPlan, RiskAlert |

---

**Fin del reporte Cortez11**